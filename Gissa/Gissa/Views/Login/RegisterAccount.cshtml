@model Gissa.Entities.Usuario
@{
    ViewData["Title"] = "RegisterAccount";
    Layout = "~/Views/Shared/_Layout _Login.cshtml";
}

<div class="content-wrapper d-flex align-items-center auth px-0">
    <div class="row w-100 mx-0">
        <div class="col-lg-8 mx-auto">
            <div class="auth-form-light text-left py-5 px-4 px-sm-5">
                <div class="brand-logo text-center">
                    <img src="~/template/images/GISSA2.png" alt="logo">
                </div>
                @if (ViewBag.UserExistsError != null)
                {
                    <div class="alert alert-danger" role="alert">
                        @ViewBag.UserExistsError
                    </div>
                }

                @using (Html.BeginForm("RegisterAccount", "Login", FormMethod.Post, new { @class = "pt-3", id = "registrationForm" }))
                {
                    @ViewBag.MensajePantalla

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="form-group mb-4">
                                <label style="font-size: 18px;">Tipo de identificación</label>
                                @Html.DropDownListFor(m => m.IdNationality, ViewBag.XYZ as List<SelectListItem>, new { @class = "form-control", @type = "text", id = "IdNationality", style = "font-size: 18px; padding: 10px;" })
                            </div>
                            <div class="form-group mb-4">
                                <label style="font-size: 18px;">Nombre</label>
                                @Html.TextBoxFor(m => m.NameUser, new { @class = "form-control", @type = "text", @placeholder = "Escriba aquí...", id = "nombre", style = "font-size: 18px; padding: 10px;" })
                                <span class="error-message" id="nombre-error"></span>
                            </div>
                            <div class="form-group mb-4">
                                <label style="font-size: 18px;">Correo Electrónico</label>
                                @Html.TextBoxFor(m => m.Email, new { @class = "form-control", @type = "email", @placeholder = "Escriba aquí...", id = "correo", style = "font-size: 18px; padding: 10px;" })
                                <span class="error-message" id="correo-error"></span>
                            </div>
                            <div class="form-group mb-4">
                                <label style="font-size: 18px;">Contraseña</label>
                                @Html.TextBoxFor(m => m.PasswordUser, new { @class = "form-control", @type = "password", @placeholder = "Escriba aquí...", id = "contrasenna", style = "font-size: 18px; padding: 10px;" })
                                <span class="error-message" id="contrasenna-error"></span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="form-group mb-4">
                                <label style="font-size: 18px;">Identificación</label>
                                @Html.TextBoxFor(m => m.Identification, new { @onkeyup = "return ConsultarNombre()", @class = "form-control", @type = "text", @placeholder = "Escriba aquí...", id = "identificacion", style = "font-size: 18px; padding: 10px;" })
                                <span class="error-message" id="identificacion-error"></span>
                            </div>
                            <div class="form-group mb-4">
                                <label style="font-size: 18px;">Apellidos</label>
                                @Html.TextBoxFor(m => m.LastName, new { @class = "form-control", @type = "text", @placeholder = "Escriba aquí...", id = "apellidos", style = "font-size: 18px; padding: 10px;" })
                                <span class="error-message" id="apellidos-error"></span>
                            </div>
                            <div class="form-group mb-4">
                                <label style="font-size: 18px;">Teléfono</label>
                                @Html.TextBoxFor(m => m.Phone, new { @class = "form-control", @type = "text", @placeholder = "Escriba aquí...", id = "telefono", style = "font-size: 18px; padding: 10px;" })
                                <span class="error-message" id="telefono-error"></span>
                            </div>
                            <div class="form-group mb-4">
                                <label style="font-size: 18px;">Confirmar Contraseña</label>
                                @Html.TextBoxFor(m => m.ConfPassUser, new { @class = "form-control", @type = "password", @placeholder = "Escriba aquí...", id = "Confcontrasenna", style = "font-size: 18px; padding: 10px;" })
                                <span class="error-message" id="Confcontrasenna-error"></span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="button" onclick="validarFormulario();" class="btn btn-block btn-primary btn-lg font-weight-medium auth-form-btn">REGISTRARSE</button>

                    </div>
                    <div class="text-center mt-4 font-weight-light">
                        ¿Ya tienes una cuenta? <a href="@Url.Action("IniciarSesion","Login")" class="text-primary">Iniciar Sesión</a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>


<style>
    .error-message {
        color: red;
        font-weight: bold;
    }
</style>

@section scripts {
    <script>
        function validarFormulario() {
            var identificacion = document.getElementById("identificacion").value;
            var nombre = document.getElementById("nombre").value;
            var apellidos = document.getElementById("apellidos").value;
            var correo = document.getElementById("correo").value;
            var telefono = document.getElementById("telefono").value;
            var contrasenna = document.getElementById("contrasenna").value;
            var Confcontrasenna = document.getElementById("Confcontrasenna").value;
            var selectedValue = document.getElementById("IdNationality").value;

            var isValid = true;

            // Resetear los mensajes de error
            resetErrorMessages();

            // Validación de identificación según el tipo seleccionado
            switch (selectedValue) {
                case '1': // Identificacion Nacional
                    if (!identificacion || !/^[0-9]{9}$/.test(identificacion)) {
                        displayErrorMessage("identificacion", "Identificación nacional debe tener 9 dígitos numéricos.");
                        isValid = false;
                    }
                    break;
                case '2': // DNI
                    if (!identificacion || !/^[0-9]{10}$/.test(identificacion)) {
                        displayErrorMessage("identificacion", "DNI debe tener 10 dígitos numéricos.");
                        isValid = false;
                    }
                    break;
                case '3': // Cedula de Extranjeria
                    if (!identificacion || !/^[0-9]{13}$/.test(identificacion)) {
                        displayErrorMessage("identificacion", "Cédula de extranjería debe tener 13 dígitos numéricos.");
                        isValid = false;
                    }
                    break;
                default:
                    displayErrorMessage("identificacion", "Seleccione un tipo de identificación válido.");
                    isValid = false;
            }

            // Validaciones restantes
            // Validación de nombre (no debe contener números)
            if (!nombre || /.*\d.*/.test(nombre)) {
                displayErrorMessage("nombre", "Nombre no debe contener números.");
                isValid = false;
            }

            // Validación de apellidos (no debe contener números)
            if (!apellidos || /.*\d.*/.test(apellidos)) {
                displayErrorMessage("apellidos", "Apellidos no deben contener números.");
                isValid = false;
            }

            // Validación de correo electrónico
            if (correo.trim() !== "" && !isValidEmail(correo)) {
                displayErrorMessage("correo", "Correo electrónico no válido.");
                isValid = false;
            }

            // Validación de teléfono (no más de 15 números)
            if (!telefono || !/^\d{1,15}$/.test(telefono)) {
                displayErrorMessage("telefono", "Teléfono debe tener entre 1 y 15 digitos.");
                isValid = false;
            }

            // Validación de contraseña (no más de 20 caracteres)
            if (!contrasenna || !/^(?=.*[a-zA-Z])(?=.*\d).{6,15}$/.test(contrasenna)) {
                displayErrorMessage("contrasenna", "La contraseña debe tener entre 6 y 15 caracteres, contener al menos una letra y al menos un número.");
                isValid = false;
            }

            // Validar que las contraseñas sean iguales
            if (contrasenna !== Confcontrasenna) {
                displayErrorMessage("Confcontrasenna", "Las contraseñas no coinciden.");
                isValid = false;
            }

            // Enviar formulario solo si es válido
            if (isValid) {
                // Mostrar SweetAlert para confirmar el registro
                Swal.fire({
                    title: "¿Estás seguro?",
                    text: "¿Quieres registrarte con los datos proporcionados?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Sí, registrarme",
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Envía el formulario
                        document.getElementById("registrationForm").submit();
                    }
                });
            }
        }

        // Función para resetear los mensajes de error
        function resetErrorMessages() {
            var errorElements = document.getElementsByClassName("error-message");
            for (var i = 0; i < errorElements.length; i++) {
                errorElements[i].innerText = "";
            }
        }

        // Función para mostrar mensajes de error
        function displayErrorMessage(elementId, message) {
            document.getElementById(elementId + "-error").innerText = message;
        }

        // Función para validar el formato de correo electrónico
        function isValidEmail(email) {
            // Utiliza una expresión regular simple para validar el formato del correo electrónico
            var emailRegex = /^.{6,}$/;
            return emailRegex.test(email);
        }

        // Agregar script para la validación de longitud de identificación según el tipo seleccionado
        $(document).ready(function () {
            $('#IdNationality').change(function () {
                var selectedValue = $(this).val();
                switch (selectedValue) {
                    case '1': // Identificacion Nacional
                        $('#identificacion').attr('maxlength', '9');
                        break;
                    case '2': // DNI
                        $('#identificacion').attr('maxlength', '10');
                        break;
                    case '3': // Cedula de Extranjeria
                        $('#identificacion').attr('maxlength', '13');
                        break;
                    default:
                        $('#identificacion').removeAttr('maxlength');
                }
            });
        });
    </script>
}