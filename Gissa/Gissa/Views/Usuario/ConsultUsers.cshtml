@model List<Gissa.Entities.Usuario>

@{
    ViewData["Title"] = "ConsultUsers";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<style>
    .pagination {
        display: flex;
        justify-content: center;
    }
</style>

<div class="col-12 grid-margin stretch-card">
    <div class="card">
        <br />
        <div class="card-body">
            <h4 class="card-title">Información de Usuarios</h4>
            <form class="d-none d-md-flex ms-4">
               
                <input class="form-control" id="searchInput" type="search" placeholder="Buscar">
            </form>
            
            <br />
            <table id="usersTable" class="table table-bordered-responsive" style="text-align:center">
                <thead style="color: white;">
                    <tr style="background-color: #96C154; ">
                        <th>Cédula</th>
                        <th>Nombre</th>
                        <th>Apellidos</th>
                        <th>Teléfono</th>
                        <th>Teléfono Secundario</th>
                        <th>Correo Electrónico</th>
                        <th>Estado</th>
                       
                        <th>Acciones</th>
                        @*<th>Actualizar</th>
                        <th>Eliminar</th>*@
                    </tr>
                </thead>
                <tbody id="searchResults" style="color: #3d4465;">
                    @if (Model != null && Model.Count > 0)
                    {
                        @foreach (var item in Model)
                        {

                            <tr>

                                <td>@item.Identification</td>
                                <td>@item.NameUser</td>
                                <td>@item.LastName</td>
                                <td>@item.Phone</td>
                                <td>@item.SecondPhone</td>
                                <td>@item.Email</td>

                                @if (@item.State)
                                {
                                    <td>Activo</td>
                                }
                                else
                                {
                                    <td>Inactivo</td>
                                }
                               
                               

                                <td class="font-weight-medium">
                                    <div class="btn-group" role="group" aria-label="Basic example">
                                        <a href="@Url.Action("UpdateState", "Usuario", new { q = item.IdUser })" class="btn btn-secondary btn-sm" data-toggle="tooltip" data-placement="top" title="Cambiar estado">
                                            <i class="ti-reload menu-icon"></i>
                                        </a>
                                        <a href="@Url.Action("UpdateUser", "Usuario", new { q = item.IdUser })" class="btn btn-info btn-sm" data-toggle="tooltip" data-placement="top" title="Editar Perfil">
                                            <i class="ti-pencil-alt"></i>
                                        </a>
                                    </div>
                                </td>

                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9">No hay usuarios para mostrar.</td>
                        </tr>
                    }
                </tbody>
            </table>
            @if (ViewBag.TotalPages > 1)
            {
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("ConsultUsers", new { page = ViewBag.CurrentPage - 1 })">Anterior</a>
                        </li>
                        @for (int i = 1; i <= ViewBag.TotalPages; i++)
                        {
                            <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                <a class="page-link" href="@Url.Action("ConsultUsers", new { page = i })">@i</a>
                            </li>
                        }
                        <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("ConsultUsers", new { page = ViewBag.CurrentPage + 1 })">Siguiente</a>
                        </li>
                    </ul>
                </nav>
            }
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    $(document).ready(function () {
        // Función para filtrar la tabla al escribir en el campo de búsqueda
        $("#searchInput").on("keyup", function () {
            var value = $(this).val().toLowerCase();
            $("#usersTable tbody tr").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
            });
        });

        // Función para eliminar un usuario
        function RemoverUsuario(idUsuario, buttonElement) {
            // Mostrar una alerta personalizada con SweetAlert2
            Swal.fire({
                title: '¿Estás seguro?',
                text: 'Esta acción eliminará permanentemente el usuario.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminarlo'
            }).then((result) => {
                if (result.isConfirmed) {
                    // olicitud AJAX para eliminar el usuario en el servidor
                    $.ajax({
                        type: 'POST',
                        url: '/Usuario/DeleteUser', 
                        data: { IdUser: IdUser },
                        success: function (data) {
                            // Eliminar la fila de la tabla si la operación en el servidor fue exitosa
                            if (data.success) {
                                $(buttonElement).closest("tr").remove();

                                // Mostrar una alerta de éxito
                                Swal.fire(
                                    'Eliminado',
                                    'El usuario ha sido eliminado correctamente.',
                                    'success'
                                );
                            } else {
                                // Mostrar una alerta de error si la operación en el servidor falló
                                // Mostrar una alerta de éxito
                                Swal.fire(
                                    'Eliminado',
                                    'El usuario ha sido eliminado correctamente.',
                                    'success'
                                );
                            }
                        },
                        error: function () {
                            // Mostrar una alerta de error si la solicitud AJAX falló
                            Swal.fire(
                                'Error',
                                'Hubo un problema al realizar la solicitud al servidor.',
                                'error'
                            );
                        }
                    });
                }
            });
        }

        // Asignar la función a los botones de eliminar
        $(".btnEliminarUsuario").on("click", function () {
            var idUsuario = $(this).data("idUsuarior");
            RemoverUsuario(idUsuario, this);
        });
    });
</script>